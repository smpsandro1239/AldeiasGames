// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Default to sqlite for dev, can be changed to postgresql
  url      = env("DATABASE_URL")
}

model User {
  id                   String                  @id @default(cuid())
  nome                 String
  email                String                  @unique
  passwordHash         String
  role                 String                  @default("CLIENTE") // SUPER_ADMIN, ADMIN, VENDEDOR, CLIENTE
  telefone             String?
  notificacoesEmail    Boolean                 @default(true)
  ultimoLogin          DateTime?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  aldeiaId             String?
  aldeia               Aldeia?                 @relation(fields: [aldeiaId], references: [id])
  participacoes        Participacao[]
  sorteiosExecutados   Sorteio[]
  notificacoes         Notificacao[]
  pushSubscriptions    PushSubscription[]
  logsAcesso           LogAcesso[]

  @@map("utilizadores")
}

model Aldeia {
  id                  String    @id @default(cuid())
  nome                String
  slug                String?   @unique
  tipoOrganizacao     String    @default("aldeia")
  descricao           String?
  localizacao         String?
  logoUrl             String?
  logoBase64          String?
  verificada          Boolean   @default(false)
  morada              String?
  codigoPostal        String?
  localidade          String?
  autorizacaoCM       Boolean   @default(false)
  numeroAlvara        String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  eventos             Evento[]
  users               User[]
  premios             Premio[]

  @@map("aldeias")
}

model Evento {
  id                  String    @id @default(cuid())
  aldeiaId            String
  titulo              String
  descricao           String?
  dataInicio          DateTime
  dataFim             DateTime
  estado              String    @default("ativo")
  imageUrl            String?
  imagemBase64        String?
  objectivoAngariacao Float?
  slug                String?   @unique
  ativo               Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  aldeia              Aldeia    @relation(fields: [aldeiaId], references: [id])
  jogos               Jogo[]

  @@index([aldeiaId])
  @@index([slug])
  @@map("eventos")
}

model Jogo {
  id                String         @id @default(cuid())
  eventoId          String
  titulo            String
  tipo              String
  config            String?        // JSON string
  precoParticipacao Float
  estado            String         @default("ativo")
  premioId          String?
  stockInicial      Int?
  stockRestante     Int?
  premiosRaspadinha String?        // JSON string
  limitePorUsuario  Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  evento            Evento         @relation(fields: [eventoId], references: [id])
  participacoes     Participacao[]
  sorteio           Sorteio?
  premio            Premio?        @relation(fields: [premioId], references: [id])

  @@index([eventoId])
  @@map("jogos")
}

model Participacao {
  id                String    @id @default(cuid())
  jogoId            String
  userId            String
  valorPago         Float
  dadosParticipacao String    // JSON string
  metodoPagamento   String    @default("mbway")
  estado            String    @default("pendente")
  referencia        String?
  telefoneMbway     String?
  ganhou            Boolean   @default(false)
  premio            String?
  adminRegistouId   String?
  nomeCliente       String?
  telefoneCliente   String?
  emailCliente      String?

  // === Raspadinha ===
  numeroCartao      Int?
  seedRaspe         String?
  hashRaspe         String?
  resultadoRaspe    String?
  revelado          Boolean   @default(false)
  reveladoAt        DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id])
  jogo              Jogo      @relation(fields: [jogoId], references: [id])

  @@index([userId])
  @@index([jogoId])
  @@index([referencia])
  @@map("participacoes")
}

model Sorteio {
  id             String   @id @default(cuid())
  jogoId         String   @unique
  resultado      String   // JSON string
  seed           String
  hash           String
  realizadoPorId String
  createdAt      DateTime @default(now())
  realizadoPor   User     @relation(fields: [realizadoPorId], references: [id])
  jogo           Jogo     @relation(fields: [jogoId], references: [id])

  @@map("sorteios")
}

model Notificacao {
  id        String   @id @default(cuid())
  userId    String
  tipo      String   @default("info")
  titulo    String
  mensagem  String
  lida      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("notificacoes")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  keys      String   // JSON string
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Premio {
  id            String   @id @default(cuid())
  aldeiaId      String
  nome          String
  descricao     String?
  valorEstimado Float?
  imageUrl      String?
  imagemBase64  String?
  patrocinador  String?
  ordem         Int      @default(0)
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  aldeia        Aldeia   @relation(fields: [aldeiaId], references: [id])
  jogos         Jogo[]

  @@map("premios")
}

model LogAcesso {
  id        String   @id @default(cuid())
  userId    String?
  ip        String?
  userAgent String?
  email     String?
  sucesso   Boolean  @default(true)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("logs_acesso")
}

model Plano {
  id                String    @id @default(cuid())
  nome              String
  precoMensal       Float     @default(0)
  maxEventos        Int       @default(3)
  maxJogos          Int       @default(10)
  maxParticipacoes  Int       @default(100)
  descricao         String?
  stripePriceId     String?
  ativo             Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("planos")
}
